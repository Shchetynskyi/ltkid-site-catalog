# Ключові рішення (SSOT)

Цей документ є **єдиним джерелом продуктових і системних рішень**.
Будь-яка логіка, що впливає на UX, дані або поведінку сайту,
**МУСИТЬ** бути зафіксована тут.

---

## 1. Catalog v2 — Source of Truth

**Status:** ACTIVE

- Google Sheets (`CATALOG_V2`) є **єдиним джерелом правди** для каталогу.
- Сайт працює **виключно в режимі read-only** з SSOT.
- Будь-які зміни структури даних:
  - тільки після усвідомленого рішення,
  - з фіксацією в цьому документі.

---

## 2. Діоптрії

**Status:** FIXED

**Source of truth:**
- колонка `Наявність діоптрій виробника`
- тільки конкретні значення

**Правила:**
- діапазони (MIN–MAX) є похідними
- діапазони НЕ є джерелом даних
- UI НЕ має права інтерпретувати або “вгадувати” діоптрії

---

## 3. Категоризація

**Status:** FIXED

- Категорія **НЕ зберігається** в таблиці.
- Категорія визначається **логікою фронтенду**
  на основі атрибутів моделі.
- У SSOT відсутнє поле `Category`.

---

## 4. Try-On / AI

**Status:** INACTIVE

- Try-On та AI Preview:
  - не інтегровані
  - існують лише як CTA
- Не мають:
  - бізнес-логіки
  - переходів
  - впливу на каталог або замовлення

---

## 5. Глобальні заборони

**Status:** ACTIVE

ЗАБОРОНЕНО:
- додавати нові UX-елементи без рішення в SSOT
- змінювати тексти кнопок
- інтегрувати оплату
- додавати бізнес-логіку без фіксації в `DECISIONS.md`

---

## 6. Site price — загальне рішення

**Status:** FIXED (immutable)

- Канонічна ціна для клієнтського UI — **`SitePriceUAH`**.
- Поля:
  - `Price` — внутрішня / закупочна ціна виробника
  - `PriceIndex` — технічний індекс
- ЖОДНЕ з цих полів **НЕ використовується напряму в UI**.

Будь-які зміни ціни на сайті можливі **тільки через це рішення**.

---

## 7. [P0] SitePriceUAH — Derived column (Google Sheets)

**Status:** FIXED (immutable)

### Призначення
`SitePriceUAH` — **єдине валідне поле ціни для сайту**.

### Джерела
- `PriceIndex` — source of truth
- `PriceMap` — відповідність `PriceIndex → PriceUAH`

### Правила
- колонка `SitePriceUAH`:
  - додається **ТІЛЬКИ** в кінець таблиці `CATALOG_V2`
  - не редагується вручну
  - формується виключно формулою
- якщо значення відсутнє або некоректне → використовується fallback

### UI rule (mandatory)
- якщо `SitePriceUAH` порожня або некоректна → UI показує:
  **“Ціну уточнюйте”**
- числовий fallback на `Price` **ЗАБОРОНЕНО**

### Канонічний патерн формули (Google Sheets)

Через обмеження Google Sheets  
(`ARRAYFORMULA` не пропускає коректно технічний рядок 2)
використовується патерн з порожнім першим елементом масиву,
аналогічний колонці `Preview`.

={"";ARRAYFORMULA(
IF(PriceIndex3:="";
"";
IFERROR(
VLOOKUP(VALUE(PriceIndex3:); PriceMap!A:B; 2; FALSE);
"Ціну уточнюйте"
)
)
)}

Цей патерн є **канонічним** і **не підлягає зміні без окремого рішення**.

---

## 8. Phase 2 — Lead Capture: сценарії та межі відповідальності

**Status:** FIXED (immutable)

### Загальний принцип
Messenger є **спільним простором клієнта і менеджера**.
Сайт SITE-CATALOG:
- є вітриною та інструментом формування ліда
- НЕ приймає рішень щодо сумісності лінз і рецепта
- НЕ гарантує відповідність зору
- НЕ продає готовий продукт без участі менеджера

Єдина задача сайту — **передати коректний контекст менеджеру**.

---

### Сценарій A — Готові окуляри (без визначення діоптрій)
- користувач переглядає готові окуляри
- діоптрії користувача не визначались
- сумісність з рецептом не гарантується

**CTA:**
- “Звʼязатися з менеджером”

---

### Сценарій B — Оправа як товар (без діоптрій)
- користувач обирає оправу (без діоптрій)
- намір: обговорити встановлення лінз в обрану оправу

**CTA:**
- “Звʼязатися з менеджером”

Підбір лінз і робота з рецептом —
**виключно зона відповідальності менеджера**.

---

### Сценарій C — Для мого зору
- не входить у Phase 2
- предмет окремого рішення (Phase 3)
- потребує окремого UX-FLOW

---

## 9. Phase 2 — LeadPayload v1 (Messenger)

**Status:** FIXED (immutable)

### Принцип
Lead payload має бути **людським і візуально зрозумілим**:
він відображає те, що бачив клієнт на сайті,
і дає менеджеру повний контекст.

### Canonical LeadPayload (Model Page)
Передається при кліку CTA **“Звʼязатися з менеджером”**
на сторінці моделі:

- `ModelID`
- `MarketingTitle`
- `SitePriceUAH`
  (рівно те, що показано в UI,
  включно з текстом **“Ціну уточнюйте”**)
- `Image` — одне зображення (preview або main)
- `ref`:
  - `site_catalog__model`
  - `site_catalog__frame`

### Conditional
- `DiopterContext` — передається **ТІЛЬКИ якщо**
  користувач обрав діоптрію у сценарії “Для мого зору”.
  Якщо діоптрія не обиралась — поле відсутнє.

### Заборонено
- передавати `Price`, `PriceIndex` або інші технічні поля
- “вгадувати” діоптрію або додавати її без дії користувача

---

## 10. UX-обмеження (Phase 2)

- UX-FLOW v1.1 — **FROZEN**
- нові кнопки типу “Обрати цю” — **ЗАБОРОНЕНІ**

На сторінці моделі існує **єдиний канонічний CTA-сценарій**
— **“Звʼязатися з менеджером”**.

Кількість **візуальних CTA-елементів**, які ведуть у цей сценарій,
**НЕ обмежується**, за умови що:
- текст CTA ідентичний,
- використовується Canonical LeadPayload v1,
- нові сценарії або логіка не додаються.

ModelID не відображається в Hero Model Page;
зберігається в даних і LeadPayload.

---

## 11. Phase 4.2.2 — Model Page CTA (Contextual Override)

**Status:** FIXED

### Problem
На сторінці моделі (Model Page) існує ризик втрати lead-контексту,
якщо користувач ініціює контакт із менеджером через Header CTA,
який за замовчуванням не формує LeadPayload.

Це призводить до ситуації, коли менеджер отримує повідомлення
без інформації про модель, яку переглядав користувач.

### Decision
На **Model Page** кнопка **“Звʼязатися з менеджером”**
у будь-якому її візуальному прояві:
- Header CTA
- візуально акцентована CTA в контенті сторінки
- CTA внизу сторінки
- sticky CTA на mobile

**ЗАВЖДИ працює як contextual CTA**
та відправляє **Canonical LeadPayload v1**.

Поза Model Page:
- Header CTA залишається **generic entry point**
- LeadPayload **НЕ формується**

### Guarantees
- Текст CTA залишається незмінним
- UX-FLOW v1.1 не змінюється
- Нові CTA-сценарії не додаються
- LeadPayload v1 залишається immutable

Це рішення є **product-level уточненням**
і **НЕ вважається додаванням нового CTA-сценарію**.

---

## 12. Phase 4.4 / 4.4.1 — Diopter context on Model Page

**Status:** FIXED (immutable)

### Problem
У флоу «Підібрати за моїм зором» обрана клієнтом діоптрія
коректно використовувалась:
- для фільтрації галереї
- для передачі контексту в Messenger

Але губилась на Model Page, якщо була передана лише
всередині параметра `from`.

У результаті користувач не бачив,
для якої діоптрії підібрана відкрита модель.

---

### Decision

1. **Єдине джерело діоптрії для Model Page — прямий query-параметр**
   
   Формат:
   `/model/{id}?diopter=+X.XX`

2. Якщо користувач прийшов з флоу підбору і має обрану діоптрію:
   - `diopter` ОБОВʼЯЗКОВО додається напряму в URL Model Page
   - `from` використовується лише для back-навігації

3. `from` ЗАБОРОНЕНО використовувати як джерело діоптрії
   (вкладені query не парсяться).

---

### UI Rule (Model Page)

- Якщо `diopter` присутній у query:
  - показується пасивний текстовий бейдж:
    **“Підібрано для діоптрії: +X.XX”**
- Якщо `diopter` відсутній:
  - бейдж НЕ показується

---

### Guarantees

- UX-flow не змінюється
- Нові CTA або сценарії не додаються
- Бізнес-логіка не додається
- Store / localStorage не використовуються

Це рішення є обовʼязковим
для всієї навігації на Model Page.


---

## 12. Phase 4.6 — Diopter flow ↔ Model Page (safe return)

**Status:** FIXED

### Problem
Користувач може перейти на сторінку моделі без вибору діоптрії
(через загальну галерею),
але на цій сторінці виникає потреба:
підібрати окуляри **під свій зір**.

Раніше:
- Model Page не мала безпечного сценарію входу у diopter-flow
- повернення на модель після вибору діоптрії було неконтрольованим
- можливі порожні галереї або втрата контексту

### Decision
На Model Page дозволено **окремий вхід у diopter-flow**
через CTA **“Підібрати під мій зір”**, за умов:

- CTA показується **лише якщо модель має DiopterValues**
- передається явний контекст повернення:
  - `return` — шлях назад
  - `returnModelId` — ID моделі (SSOT)
- diopter-flow приймає рішення серверно

### Return rules (canonical)
Після вибору діоптрії:

**Якщо модель підтримує обрану діоптрію**
→ redirect на  
`/model/{ModelID}?diopter=+X.XX`

**Якщо модель НЕ підтримує діоптрію**
→ повернення на Model Page НЕ відбувається  
→ користувач залишається у галереї моделей,
відфільтрованій по діоптрії

Зверху показується повідомлення:
> “Цієї моделі немає для +X.XX. Ось інші варіанти.”

**Якщо для діоптрії немає жодної ready-моделі**
→ контрольований redirect у Messenger
→ передається DiopterContext

### Guarantees
- UX-flow не ламається
- Порожні галереї виключені
- Messenger використовується тільки як fallback
- Жодної клієнтської бізнес-логіки
- SSOT збережено

Це рішення є **канонічним** для роботи з діоптріями
на сторінці моделі.

## Phase 5.1 — Home Entry: READY_ONLY Launch Mode

**Status:** FIXED

### Decision
На старті продукт запускається в режимі **READY_ONLY**.

Home-екран відображає **лише сценарії готових окулярів**:
- «Готові окуляри · Жіночі»
- «Готові окуляри · Чоловічі»

Сценарії «Оправи»:
- тимчасово **приховані з UI**
- не мають disabled-станів або плейсхолдерів
- не згадуються користувачу

### Rules
- UX-FLOW v1.1 — без змін
- маршрути та логіка — без змін
- структура та код для Frames зберігаються для майбутнього ввімкнення
- при знятті READY_ONLY Home масштабується до 4 сценаріїв без зміни логіки

Це рішення є **режимом запуску продукту**, а не UX-зміною.

# DECISIONS.md — додати НЕ ПОТРІБНО (вже є)

# Якщо хочеш просто перевірити, що блок існує:
## Phase 5.1 — Home Entry: READY_ONLY Launch Mode

**Status:** FIXED

### Decision
На старті продукт запускається в режимі **READY_ONLY**.

Home-екран відображає лише сценарії готових окулярів:
- «Готові окуляри · Жіночі»
- «Готові окуляри · Чоловічі»

Сценарії «Оправи» тимчасово приховані з UI (без disabled/placeholder).

## 2026-01-30 — Telegram in-app System Back (WebView) = platform limitation

**Decision:** Поведінка system back у Telegram in-app browser (WebView), коли натискання “Back” закриває webview замість повернення на попередній екран, вважається **platform limitation**, а не дефектом SITE-CATALOG.

**Constraints:**
- Не додаємо кастомну кнопку Back (UX-FLOW v1.1 FROZEN).
- Не змінюємо маршрути/URL/тексти/флоу під Telegram.
- Навігація продукту залишається стандартною SPA-навігацією (SvelteKit `goto()`), без кастомних history-хаків.

**Acceptance:**
- У звичайних браузерах (Chrome/Safari, mobile/desktop) system back працює очікувано.
- У Telegram in-app: поведінка back не “фікситься” кодом, і це приймається як обмеження платформи.
- Рекомендація для комунікацій: “Для коректної навігації відкрийте в браузері”.

## Phase 6 — Home vs Select: Overlay Panel Decision

**Decision:** Home та Select мають **різну стилістику**, відповідно до ролі екранів.

- **Home** — БЕЗ плашки під текст.
- **Select** — З напівпрозорою плашкою для читабельності.

**Rationale:**
- Home = емоційний entry-екран.
- Select = утилітарний екран вибору.
- Уніфікація плашки знизила б ефективність кожного з екранів.

**Constraints:**
- Плашка НЕ додається на Home.
- Плашка ЗАЛИШАЄТЬСЯ на Select.
- Тексти, CTA, логіка, UX-FLOW — без змін.

**Acceptance:**
- Home виглядає легше за Select.
- Select читається краще за Home.
- Візуальна різниця сприймається як усвідомлена, а не випадкова.

## Deployment & Production Flow (GitHub + Vercel)

**Status:** FIXED (immutable)

### Decision
- Єдина production-гілка: `main`
- `main` автоматично деплоїться у Vercel Production
- Прямі push у `main` заборонені
- Єдиний шлях у production: Pull Request → merge

### Rules
- Будь-які зміни: feature-branch → PR → merge → production
- Branch Protection для `main` увімкнено
- Bypass для адміністраторів вимкнено
- Vercel Preview використовується для перевірки PR

### Acceptance
- PR-флоу перевірено на практиці
- Production завжди відповідає `main`
- Неконтрольований деплой виключений

## Messenger Integration — Context Transfer Limitation (Meta)

**Status:** FIXED (immutable)

### Decision
Інтеграція SITE-CATALOG з Messenger (ManyChat) **НЕ гарантує**
автоматичну передачу контексту вибору користувача
(модель, діоптрія, сторінка)
менеджеру **без активної дії користувача в чаті**.

Це є **платформним обмеженням Meta (privacy / anti-spam)**,
а не проблемою реалізації або ManyChat.

### Scope
- Messenger використовується як **канал живого спілкування**.
- Сайт використовується як **інструмент самостійного вибору**.
- Автоматичне повідомлення менеджеру з контекстом
  без дії користувача **не очікується і не вимагається**.

### Rejected
- Спроби “зберігати контекст” у Messenger заднім числом
- Ускладнення ManyChat-флоу для обходу обмежень
- Використання ManyChat як системи даних або логіки

### Notes
Експериментальні зміни коду, пов’язані з MC-інтеграцією,
не прийняті і **відкочені**.

## MC-6 — Canon Decision

Context:
Сайт передає вхідні дані клієнта (модель, діоптрії, ціна) у Messenger.
Потрібно автоматизувати перший контакт менеджера без ручних дій.

Decision:
MC-6 зафіксовано як обовʼязковий етап.
ManyChat використовується для:
— прийому payload із сайту
— формування першого повідомлення менеджеру клієнту
— логування ліда

Consequences:
— Менеджер не вводить дані вручну
— Є єдиний сценарій першого контакту
— ManyChat залишається ядром комунікації

Scope:
— тільки передача payload із сайту → ManyChat
— тільки перше повідомлення менеджеру
— без логіки продажу, без бот-діалогів
— без змін UI сайту

Payload (canonical):
— model_id
— model_name
— price_uah
— diopter_left
— diopter_right
— cylinder (optional)
— axis (optional)
— source = site
— timestamp

Trigger:
— submit форми на сайті
— успішна валідація payload
— миттєва передача в ManyChat

Done:
— payload доходить у ManyChat без втрат
— менеджер отримує перше повідомлення з даними моделі та діоптрій
— ручне введення даних = 0
